<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Custom New Tab</title>
<style>
  :root{--accent: rgba(255,255,255,0.85);}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    padding:0;
    font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
    color:var(--accent);
    background: center / cover no-repeat url("cah.png");
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }
  .time {
    font-weight: 300;
    font-size: 3.2rem;
    letter-spacing: 0.02em;
    text-shadow: 0 6px 18px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.02) inset;
    margin-bottom: 6px;
    transform: translateY(-12%);
  }
  .date {
    font-weight: 300;
    font-size: 1.1rem;
    opacity: 0.95;
    transform: translateY(-8%);
    margin-bottom: 1.6rem;
  }
  .search-wrap{
    width: min(78vw, 820px);
    max-width: 920px;
    padding: 18px;
    border-radius: 14px;
    backdrop-filter: blur(12px) saturate(120%);
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    box-shadow: 0 10px 40px rgba(3,6,12,0.6);
    display:flex;
    align-items:center;
  }
  form.search {
    display:flex;
    width:100%;
    gap: 12px;
    align-items:center;
  }
  input.q {
    flex:1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--accent);
    font-size:1.05rem;
    padding: 8px 6px;
    font-weight: 300;
  }
  button.search-btn{
    border: none;
    background: rgba(255,255,255,0.06);
    height:44px;
    width:44px;
    border-radius: 10px;
    display:grid;
    place-items:center;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease;
    padding:0;
  }
  button.search-btn:active{transform:scale(.98)}
  button.search-btn:focus{outline:2px solid rgba(255,255,255,0.08)}
  .icon{
    width:20px;
    height:20px;
    display:block;
    opacity:0.95;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,0.45));
  }
  .ip {
    position: fixed;
    left: 12px;
    bottom: 10px;
    font-size: 0.85rem;
    background: rgba(0,0,0,0.25);
    padding: 8px 10px;
    border-radius: 8px;
    backdrop-filter: blur(6px);
    box-shadow: 0 4px 18px rgba(0,0,0,0.5);
    color: #e6eef8;
    font-weight: 300;
  }
  @media (max-width:560px){
    .time{font-size:2.2rem}
    .date{font-size:1rem}
    .search-wrap{padding:12px;border-radius:12px}
    button.search-btn{height:38px;width:38px}
  }
</style>
</head>
<body>
  <div style="height:8vh"></div>
  <div class="time" id="time">—:—</div>
  <div class="date" id="date">Loading date...</div>
  <div class="search-wrap">
    <form class="search" id="searchForm" action="https://www.google.com/search" method="GET" target="_self">
      <input class="q" id="q" name="q" placeholder="Search Google..." autocomplete="off">
      <button type="submit" class="search-btn">
        <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="10.5" cy="10.5" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </form>
  </div>
  <div id="ip" class="ip">IP: fetching…</div>
<script>
(function startClock(){
  const tEl = document.getElementById('time');
  const dEl = document.getElementById('date');
  function update(){
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit', hour12: true});
    tEl.textContent = timeStr;
    const dateStr = now.toLocaleDateString([], {weekday: 'long', month: 'long', day: 'numeric'});
    dEl.textContent = dateStr;
  }
  update();
  setInterval(update, 1000);
})();
document.getElementById('searchForm').addEventListener('submit', function(e){
  const q = document.getElementById('q');
  if(!q.value.trim()){
    e.preventDefault();
    q.focus();
    return false;
  }
});
const ipEl = document.getElementById('ip');
const IP_KEY = 'cached_ip_v1';
const IP_TS_KEY = 'cached_ip_ts_v1';
const IP_MAX_AGE = 1000 * 60 * 60 * 24 * 7;
async function fetchAndCacheIP(){
  try {
    const controller = new AbortController();
    const timeout = setTimeout(()=>controller.abort(), 7000);
    const res = await fetch('https://api.ipify.org?format=json', {signal: controller.signal});
    clearTimeout(timeout);
    if(!res.ok) throw new Error('Network response not ok');
    const j = await res.json();
    if(j && j.ip){
      localStorage.setItem(IP_KEY, j.ip);
      localStorage.setItem(IP_TS_KEY, Date.now().toString());
      showIP(j.ip, false);
    } else { throw new Error('Bad JSON'); }
  } catch(err) {
    const cached = localStorage.getItem(IP_KEY);
    const ts = parseInt(localStorage.getItem(IP_TS_KEY) || '0', 10);
    if(cached){
      const age = Date.now() - ts;
      const note = age > IP_MAX_AGE ? ' (cached, old)' : ' (cached)';
      showIP(cached, true, note);
    } else { ipEl.textContent = 'IP: unavailable'; }
  }
}
function showIP(ip, offline=false, note=''){
  ipEl.textContent = `IP: ${ip}${note || (offline ? ' (cached)' : '')}`;
}
if(navigator.onLine){ fetchAndCacheIP(); }
else {
  const cached = localStorage.getItem(IP_KEY);
  if(cached){ showIP(cached, true); }
  else { ipEl.textContent = 'IP: offline (no cached IP)'; }
}
window.addEventListener('online', fetchAndCacheIP);
(async function registerSWFromBlob(){
  if(!('serviceWorker' in navigator)){ return; }
  const swScript = `
    const CACHE_NAME = 'newtab-cache-v1';
    const CORE = ['/'];
    async function populateCache() {
      const cache = await caches.open(CACHE_NAME);
      try { await cache.addAll(CORE); } catch(e){}
      try { await cache.add('cah.png'); } catch(e){}
    }
    self.addEventListener('install', (evt) => {
      self.skipWaiting();
      evt.waitUntil(populateCache());
    });
    self.addEventListener('activate', (evt) => {
      evt.waitUntil(self.clients.claim());
    });
    self.addEventListener('fetch', (evt) => {
      const req = evt.request;
      if (req.method !== 'GET') return;
      evt.respondWith(
        caches.match(req).then(cached => {
          if(cached) return cached;
          return fetch(req).then(networkRes => {
            if(networkRes && networkRes.ok){
              const copy = networkRes.clone();
              caches.open(CACHE_NAME).then(cache => { try { cache.put(req, copy); } catch(e){} });
            }
            return networkRes;
          }).catch(() => {
            if(req.mode === 'navigate' || (req.headers && req.headers.get('accept') && req.headers.get('accept').includes('text/html'))){
              return caches.match('index.html').then(c => c || Response.error());
            }
            return Response.error();
          });
        })
      );
    });
    self.addEventListener('message', (e) => {
      if(e.data === 'skip-waiting') self.skipWaiting();
    });
  `;
  try {
    const blob = new Blob([swScript], {type: 'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    await navigator.serviceWorker.register(swUrl);
  } catch(err){
    try { await navigator.serviceWorker.register('sw.js'); } catch(err2){}
  }
})();
</script>
</body>
</html>
